
// ---- Start of ShopEaseBackendApplication.java ----
package com.shopease.backend;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class ShopEaseBackendApplication {

	public static void main(String[] args) {
		SpringApplication.run(ShopEaseBackendApplication.class, args);
	}

}

// ---- End of ShopEaseBackendApplication.java ----


// ---- Start of AppConfig.java ----
package com.shopease.backend.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
public class AppConfig 
{
	@Bean
	public PasswordEncoder passwordEncoder()
	{
		return new BCryptPasswordEncoder();
	}
}

/*
PasswordEncoder (BCrypt)
What is it?

It is a component that encrypts (hashes) passwords before storing them in the database.
We never store plain passwords.
*/

/*
Why BCrypt?
BCrypt:

Adds salt automatically 
Slow hashing → prevents brute force attacks 
Industry standard for authentication
 */


// ---- End of AppConfig.java ----


// ---- Start of SecurityConfig.java ----
package com.shopease.backend.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

import com.shopease.backend.security.JwtAuthenticationFilter;

@Configuration
@EnableMethodSecurity
public class SecurityConfig 
{
	private final JwtAuthenticationFilter jwtAuthFilter;
	
	public SecurityConfig(JwtAuthenticationFilter jwtAuthFilter) 
	{
        this.jwtAuthFilter = jwtAuthFilter;
    }
	
	@Bean
	public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception
	{
		http.csrf(csrf -> csrf.disable());
		
		http.sessionManagement(session ->
								session.sessionCreationPolicy(SessionCreationPolicy.STATELESS));
		
		http.authorizeHttpRequests(auth -> auth
				.requestMatchers("/auth/**").permitAll()
				.anyRequest().authenticated());
		
		http.addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);
		
		return http.build();
	}
	
	@Bean
	public AuthenticationManager authenticationmanager(AuthenticationConfiguration config) throws Exception
	{
		return config.getAuthenticationManager();
	}
}




















// ---- End of SecurityConfig.java ----


// ---- Start of CartController.java ----
package com.shopease.backend.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.shopease.backend.entity.Cart;
import com.shopease.backend.service.CartService;

@RestController
@RequestMapping("/cart")
public class CartController
{
	@Autowired
	private CartService cartService;
	
	// Get cart for user
	@GetMapping("/{userId}")
	public ResponseEntity<Cart> getCart(@PathVariable Long userId)
	{
		Cart cart = cartService.getCartByUser(userId);
		
		if(cart == null)
			return ResponseEntity.notFound().build();
		
		return ResponseEntity.ok(cart);
	}
	
	// Add product to cart
    @PostMapping("/{userId}/add/{productId}/{quantity}")
    public ResponseEntity<Cart> addProductToCart(
    		@PathVariable Long userId,
    		@PathVariable Long productId,
    		@PathVariable int quantity
    		)
    {
    	Cart cart = cartService.addProductToCart(userId, productId, quantity);
    	
    	if(cart==null)
    		return ResponseEntity.notFound().build();
    	
		return ResponseEntity.ok(cart);
    }
    
    // Remove cart item
    @DeleteMapping("/{userId}/remove/{cartItemId}")
    public ResponseEntity<Cart> removeItem(
    		@PathVariable Long userId,
    		@PathVariable Long cartItemId)
    {
    	Cart cart = cartService.removeItemFromCart(userId, cartItemId);
    	return ResponseEntity.ok(cart);
    }
}











// ---- End of CartController.java ----


// ---- Start of CategoryController.java ----
package com.shopease.backend.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.shopease.backend.entity.Category;
import com.shopease.backend.service.CategoryService;

@RestController
@RequestMapping("api/categories")
public class CategoryController 
{
	@Autowired
	private CategoryService categoryService;
	
	// Create Category
	@PostMapping
	public Category createCategory(@RequestBody Category category)
	{
		return categoryService.createCategory(category);
	}
	
	// Get All Categories
    @GetMapping
    public List<Category> getAllCategories() 
    {
        return categoryService.getAllCategories();
    }
}

// ---- End of CategoryController.java ----


// ---- Start of OrderController.java ----
package com.shopease.backend.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.shopease.backend.entity.Order;
import com.shopease.backend.service.OrderService;

@RestController
@RequestMapping("/orders")
public class OrderController 
{
	@Autowired
	private OrderService orderService;
	
	@PostMapping("/place/{userId}")
	public ResponseEntity<Order> placeOrder(@PathVariable Long userId)
	{
		Order order = orderService.placeOrder(userId);
		
		if(order == null)
			return ResponseEntity.badRequest().build();
		
		return ResponseEntity.ok(order);
		
	}
	
	@GetMapping("/user/{userId}")
	public ResponseEntity<List<Order>> getUserOrders(@PathVariable Long userId)
	{
		List<Order> orders = orderService.getOrdersByUser(userId);
		return ResponseEntity.ok(orders);
	}
	
	@GetMapping("/{orderId}")
	public ResponseEntity<Order> getOrderById(@PathVariable Long orderId)
	{
		Order order = orderService.getOrderById(orderId);
		
		if (order == null)
			return ResponseEntity.notFound().build();
		
		return ResponseEntity.ok(order);
	}
	
	@PutMapping("/cancel/{orderId}")
	public ResponseEntity<?> cancelOrder(@PathVariable Long orderId)
	{
		Order cancelledOrder = orderService.cancelOrder(orderId);
		
		if (cancelledOrder == null)
			return ResponseEntity.badRequest().body("Cannot cancel this order");
		
		return ResponseEntity.ok(cancelledOrder);
	}
}

// ---- End of OrderController.java ----


// ---- Start of ProductController.java ----
package com.shopease.backend.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.shopease.backend.entity.Product;
import com.shopease.backend.service.ProductService;

@RestController
@RequestMapping("/products")
public class ProductController 
{
	@Autowired
	ProductService productService;
	
	// Add Product
	@PostMapping
	public ResponseEntity<Product> addProduct(@RequestBody Product product)
	{
		Product saved = productService.addProduct(product);
		return ResponseEntity.ok(saved);
	}
	
	// Get All Products
	@GetMapping
	public ResponseEntity<List<Product>> getAllProducts()
	{
		return ResponseEntity.ok(productService.getAllProducts());
	}
	
	// Get Product By ID
	@GetMapping("/{id}")
	public ResponseEntity<Product> getProduct(@PathVariable Long id)
	{
		Product product = productService.getProductById(id);
		if(product == null)
		{
			return ResponseEntity.notFound().build();
		}
		return ResponseEntity.ok(product);
	}
	
	// Update Product By ID
    @PutMapping("/{id}")
    public ResponseEntity<Product> updateProduct(@PathVariable Long id,@RequestBody Product updatedProduct) 
    {
        Product product = productService.updateProduct(id, updatedProduct);
        if (product == null) {
            return ResponseEntity.notFound().build();
        }
        return ResponseEntity.ok(product);
    }
    
	// Delete Product
	@DeleteMapping("/{id}")
	public ResponseEntity<String> deleteProduct(@PathVariable Long id)
	{
		productService.deleteProduct(id);
		return ResponseEntity.ok("Product deleted Successfully");
	}
}

// ---- End of ProductController.java ----


// ---- Start of UserController.java ----
package com.shopease.backend.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.shopease.backend.entity.User;
import com.shopease.backend.service.UserService;

@RestController
@RequestMapping("/api/auth")
public class UserController 
{
	@Autowired
	private UserService userService;
	
	@PostMapping("/register")
	public User registerUser(@RequestBody User user)
	{
		return userService.registerUser(user);
	}
	
	@GetMapping("/user/{email}")
	public User findUser(@PathVariable String email)
	{
		return userService.findByEmail(email);
	}
	
	
}


/*
 * What is a Controller? 
 * A controller: receives API requests calls the service
 * layer returns responses back to the client (Postman / frontend)
 * 
 * Example: POST /api/auth/register POST /api/auth/login
 */

// ---- End of UserController.java ----


// ---- Start of AuthenticationRequest.java ----
package com.shopease.backend.dto;

public class AuthenticationRequest 
{
	private String email;
	private String password;
	
	public String getEmail() {
		return email;
	}
	public void setEmail(String email) {
		this.email = email;
	}
	public String getPassword() {
		return password;
	}
	public void setPassword(String password) {
		this.password = password;
	}
}

/*
>DTOs (Data Transfer Objects) are simple classes used ONLY to exchange data in APIs.
>A Data Transfer Object is a design pattern that allows for the exchange of data 
between software application subsystems or layers.
*/
// ---- End of AuthenticationRequest.java ----


// ---- Start of AuthenticationResponse.java ----
package com.shopease.backend.dto;

public class AuthenticationResponse 
{
    private String token;
    private String message;
    
	public AuthenticationResponse(String token, String message) 
	{
		this.token = token;
		this.message = message;
	}

	public String getToken() {
		return token;
	}

	public String getMessage() {
		return message;
	}
    
    
}

// ---- End of AuthenticationResponse.java ----


// ---- Start of RegisterRequest.java ----
package com.shopease.backend.dto;

import com.shopease.backend.entity.Role;

public class RegisterRequest
{
    private String name;
    private String email;
    private String password;
    private Role role;
    
	public String getName() {
		return name;
	}
	public void setName(String name) {
		this.name = name;
	}
	public String getEmail() {
		return email;
	}
	public void setEmail(String email) {
		this.email = email;
	}
	public String getPassword() {
		return password;
	}
	public void setPassword(String password) {
		this.password = password;
	}
	public Role getRole() {
		return role;
	}
	public void setRole(Role role) {
		this.role = role;
	}
    
    
}

// ---- End of RegisterRequest.java ----


// ---- Start of Cart.java ----
package com.shopease.backend.entity;

import java.util.List;

import jakarta.persistence.CascadeType;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.OneToMany;
import jakarta.persistence.OneToOne;
import jakarta.persistence.Table;

@Entity
@Table(name="carts")
public class Cart 
{
	@Id
	@GeneratedValue(strategy=GenerationType.IDENTITY)
	private Long id;
	
	@OneToOne
	@JoinColumn(name="user_id")
	private User user;
	
	@OneToMany(mappedBy="cart",cascade=CascadeType.ALL, orphanRemoval=true)
	private List<CartItem> cartItems;
	
	private double totalPrice;

	public Long getId() {
		return id;
	}

	public void setId(Long id) {
		this.id = id;
	}

	public User getUser() {
		return user;
	}

	public void setUser(User user) {
		this.user = user;
	}

	public List<CartItem> getCartItems() {
		return cartItems;
	}

	public void setCartItems(List<CartItem> cartItems) {
		this.cartItems = cartItems;
	}

	public double getTotalPrice() {
		return totalPrice;
	}

	public void setTotalPrice(double totalPrice) {
		this.totalPrice = totalPrice;
	}
	
	
	
}

// ---- End of Cart.java ----


// ---- Start of CartItem.java ----
package com.shopease.backend.entity;

import jakarta.persistence.*;

@Entity
@Table(name="cart_items")
public class CartItem 
{
	@Id
	@GeneratedValue(strategy=GenerationType.IDENTITY)
	private Long id;
	
	@ManyToOne
	@JoinColumn(name="cart_id")
	private Cart cart; // Each CartItem belongs to a Cart
	
	@ManyToOne
	@JoinColumn(name="product_id")
	private Product product; // Each CartItem points to a Product
	
	private int quantity;
	
	private double price; // price = product.price * quantity

	public Long getId() {
		return id;
	}

	public void setId(Long id) {
		this.id = id;
	}

	public Cart getCart() {
		return cart;
	}

	public void setCart(Cart cart) {
		this.cart = cart;
	}

	public Product getProduct() {
		return product;
	}

	public void setProduct(Product product) {
		this.product = product;
	}

	public int getQuantity() {
		return quantity;
	}

	public void setQuantity(int quantity) {
		this.quantity = quantity;
	}

	public double getPrice() {
		return price;
	}

	public void setPrice(double price) {
		this.price = price;
	}
	
	
}

// ---- End of CartItem.java ----


// ---- Start of Category.java ----
package com.shopease.backend.entity;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;

@Entity
@Table(name="categories")
public class Category 
{
	@Id
	@GeneratedValue(strategy=GenerationType.IDENTITY)
	private Long id;
	
	@Column(nullable=false,unique=true)
	private String name;
	
	private String description;

	public Category() {	}

	public Category(String name, String description) 
	{
		this.name = name;
		this.description = description;
	}
	
    public Long getId() 
    {
        return id;
    }
	
    public String getName() 
    {
        return name;
    }

    public void setName(String name) 
    {
        this.name = name;
    }

    public String getDescription() 
    {
        return description;
    }

    public void setDescription(String description) 
    {
        this.description = description;
    }
	
    
}

// ---- End of Category.java ----


// ---- Start of Order.java ----
package com.shopease.backend.entity;

import java.time.LocalDateTime;
import java.util.List;

import com.fasterxml.jackson.annotation.JsonManagedReference;

import jakarta.persistence.CascadeType;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.OneToMany;
import jakarta.persistence.Table;

@Entity
@Table(name="orders")
public class Order
{
	@Id
	@GeneratedValue(strategy=GenerationType.IDENTITY)
	private Long id;
	
	// User who placed the order
	@ManyToOne
	@JoinColumn(name="user_id")
	private User user;
	
	// Order items
	@OneToMany(mappedBy="order", cascade=CascadeType.ALL)
	@JsonManagedReference
	private List<OrderItem> items;
	
    private double totalAmount;

    @Enumerated(EnumType.STRING)
    private OrderStatus status;
 // PENDING, CONFIRMED, SHIPPED, DELIVERED

    private LocalDateTime createdAt;
    
 // getters & setters
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public User getUser() { return user; }
    public void setUser(User user) { this.user = user; }

    public List<OrderItem> getItems() { return items; }
    public void setItems(List<OrderItem> items) { this.items = items; }

    public double getTotalAmount() { return totalAmount; }
    public void setTotalAmount(double totalAmount) { this.totalAmount = totalAmount; }

    public OrderStatus getStatus() { return status; }
    public void setStatus(OrderStatus status) { this.status = status; }

    public LocalDateTime getCreatedAt() { return createdAt; }
    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }
}

// ---- End of Order.java ----


// ---- Start of OrderItem.java ----
package com.shopease.backend.entity;

import com.fasterxml.jackson.annotation.JsonBackReference;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.Table;

@Entity
@Table(name="order_items")
public class OrderItem 
{
	@Id
	@GeneratedValue(strategy=GenerationType.IDENTITY)
	private Long id;
	
	// Order reference
	@ManyToOne
	@JoinColumn(name="order_id")
	@JsonBackReference
	private Order order;
	
	// product ref
	@ManyToOne
	@JoinColumn(name="product_id")
	private Product product;
	
	private int quantity;
    private double price; // quantity * product price
    
    // getters & setters
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public Order getOrder() { return order; }
    public void setOrder(Order order) { this.order = order; }

    public Product getProduct() { return product; }
    public void setProduct(Product product) { this.product = product; }

    public int getQuantity() { return quantity; }
    public void setQuantity(int quantity) { this.quantity = quantity; }

    public double getPrice() { return price; }
    public void setPrice(double price) { this.price = price; }
}

// ---- End of OrderItem.java ----


// ---- Start of OrderStatus.java ----
package com.shopease.backend.entity;

public enum OrderStatus
{
	PENDING,
	CANCELLED
}

// ---- End of OrderStatus.java ----


// ---- Start of Product.java ----
package com.shopease.backend.entity;

import jakarta.persistence.*;

@Entity
@Table(name="products")
public class Product 
{
	@Id
	@GeneratedValue(strategy=GenerationType.IDENTITY)
	private Long id;
	
	private String name;
	
	private String description;
	
	private double price;
	
	@ManyToOne
	@JoinColumn(name="category_id")
	private Category category;
	
	public Product()
	{
	}

	public Product(String name, String description, double price, Category category)
	{
		super();
		this.name = name;
		this.description = description;
		this.price = price;
		this.category = category;
	}

	public Long getId() {
		return id;
	}

	public void setId(Long id) {
		this.id = id;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public String getDescription() {
		return description;
	}

	public void setDescription(String description) {
		this.description = description;
	}

	public double getPrice() {
		return price;
	}

	public void setPrice(double price) {
		this.price = price;
	}

	public Category getCategory() {
		return category;
	}

	public void setCategory(Category category) {
		this.category = category;
	}	
	
}

// ---- End of Product.java ----


// ---- Start of Role.java ----
package com.shopease.backend.entity;

public enum Role 
{
	ADMIN,
	CUSTOMER
}

// ---- End of Role.java ----


// ---- Start of User.java ----
package com.shopease.backend.entity;

import com.fasterxml.jackson.annotation.JsonIgnore;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;

@Entity
@Table(name="users")
public class User 
{
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long id;
	
	private String name;
	
	@Column(unique=true,nullable=false)
	private String email;
	
	// will store bcrypt hash; hide from JSON responses
    @Column(nullable = false)
    @JsonIgnore
	private String password;
	
    @Enumerated(EnumType.STRING)
	private Role role;//Admin or Customer
	
	public User()
	{
	}

	public User(String name, String email, String password, Role role) 
	{
		this.name = name;
		this.email = email;
		this.password = password;
		this.role = role;
	}

	public long getId() {
		return id;
	}

	public void setId(long id) {
		this.id = id;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public String getEmail() {
		return email;
	}

	public void setEmail(String email) {
		this.email = email;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}

	public Role getRole() {
		return role;
	}

	public void setRole(Role role) {
		this.role = role;
	}

	
}

// ---- End of User.java ----


// ---- Start of CartItemRepository.java ----
package com.shopease.backend.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import com.shopease.backend.entity.CartItem;

public interface CartItemRepository  extends JpaRepository<CartItem, Long>
{
	
}

// ---- End of CartItemRepository.java ----


// ---- Start of CartRepository.java ----
package com.shopease.backend.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import com.shopease.backend.entity.Cart;
import com.shopease.backend.entity.User;

public interface CartRepository extends JpaRepository<Cart, Long> 
{
	Cart findByUser(User user);
}

// ---- End of CartRepository.java ----


// ---- Start of CategoryRepository.java ----
package com.shopease.backend.repository;

import org.springframework.data.jpa.repository.JpaRepository;

import com.shopease.backend.entity.Category;

public interface CategoryRepository extends JpaRepository<Category,Long>
{
	
}

// ---- End of CategoryRepository.java ----


// ---- Start of OrderItemRepository.java ----
package com.shopease.backend.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import com.shopease.backend.entity.OrderItem;

public interface OrderItemRepository extends JpaRepository<OrderItem, Long> {

}
// ---- End of OrderItemRepository.java ----


// ---- Start of OrderRepository.java ----
package com.shopease.backend.repository;

import java.util.List;
import org.springframework.data.jpa.repository.JpaRepository;

import com.shopease.backend.entity.Order;

public interface OrderRepository extends JpaRepository<Order, Long>
{
	List<Order> findByUserId(Long userId);

}
// ---- End of OrderRepository.java ----


// ---- Start of ProductRepository.java ----
package com.shopease.backend.repository;

import org.springframework.data.jpa.repository.JpaRepository;

import com.shopease.backend.entity.Product;

public interface ProductRepository extends JpaRepository<Product,Long>
{

}

// ---- End of ProductRepository.java ----


// ---- Start of UserRepository.java ----
package com.shopease.backend.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import com.shopease.backend.entity.User;

public interface UserRepository extends JpaRepository<User,Long>
{
	// Custom finder method to find user by email
	User findByEmail(String email);
}


/*
 * What is a Repository? (Simple Explanation)
 * 
 * A repository is a class that talks to the database. Instead of writing SQL
 * manually, Spring JPA lets you access data using methods.
 */
// ---- End of UserRepository.java ----


// ---- Start of CustomUserDetailsService.java ----
package com.shopease.backend.security;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import com.shopease.backend.entity.User;
import com.shopease.backend.repository.UserRepository;

@Service
public class CustomUserDetailsService implements UserDetailsService
{
	@Autowired
	private UserRepository userRepository;
	
	/*This method is called automatically during login process.
	This converts your own User entity into a Spring Security UserDetails object.
	It maps your custom user → spring security user.
	& return a Spring Security UserDetails object. */
	
	@Override
	public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException 
	{
		User user = userRepository.findByEmail(email);
		
		if (user==null)
			throw new UsernameNotFoundException("User not found: " + email);
		
		return org.springframework.security.core.userdetails.User
				.withUsername(user.getEmail())
				.password(user.getPassword())
				.roles(user.getRole().name())
				.build();
	}
	
}

// ---- End of CustomUserDetailsService.java ----


// ---- Start of JwtAuthenticationFilter.java ----
package com.shopease.backend.security;

import java.io.IOException;

import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter
{
	private final JwtService jwtService;
    private final CustomUserDetailsService userDetailsService;

    public JwtAuthenticationFilter(JwtService jwtService, CustomUserDetailsService userDetailsService) 
    {
        this.jwtService = jwtService;
        this.userDetailsService = userDetailsService;
    }
    
	@Override
	protected void doFilterInternal(HttpServletRequest request,
									HttpServletResponse response, 
									FilterChain filterChain)
			throws ServletException, IOException 
	{
		String authHeader = request.getHeader("Authorization");
		
		if (authHeader == null || !authHeader.startsWith("Bearer ")) 
		{
			filterChain.doFilter(request, response);
			return;
		}
		
		String jwt = authHeader.substring(7);
		String email = jwtService.extractUsername(jwt);
		
		if (email != null && SecurityContextHolder.getContext().getAuthentication() == null)
		{
			UserDetails userDetails = userDetailsService.loadUserByUsername(email);
			
			if(jwtService.isTokenValid(jwt, userDetails))
			{
				UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(userDetails,null,userDetails.getAuthorities());
				authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
				
				SecurityContextHolder.getContext().setAuthentication(authToken);
			}	
		}
		filterChain.doFilter(request, response);		
	}
	
}
/*
User → POST /auth/login → gets JWT → stores in localStorage/postman

Every future request:
→ Authorization: Bearer <token>
→ JWT Filter verifies token
→ If valid → Spring Security allows request
→ If invalid → Reject (401 Unauthorized) 
*/

// ---- End of JwtAuthenticationFilter.java ----


// ---- Start of JwtService.java ----
package com.shopease.backend.security;

import java.security.Key;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;

import com.shopease.backend.entity.User;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;

@Service
public class JwtService 
{
	@Value("${jwt.secret}")
	private String secretKey;
	
	@Value("${jwt.expiration}")
	private long jwtExpirationMs;
	

	/* 	JWT needs a cryptographic key to sign the token.
		We convert your secret key text into a valid Key object. 	 */
	private Key getSignInKey()
	{
		return Keys.hmacShaKeyFor(secretKey.getBytes());
	}
	
	public String generateToken(User user)
	{
		Map<String,Object> claims = new HashMap<>();
		claims.put("role", user.getRole().name());
		
		return Jwts.builder()
				.setClaims(claims)
				.setSubject(user.getEmail())
				.setIssuedAt(new Date())
				.setExpiration(new Date(System.currentTimeMillis() + jwtExpirationMs))
				.signWith(getSignInKey(),SignatureAlgorithm.HS256)
				.compact();
	}
	
	/*This verifies:
		>Signature is correct
		>Token is legitimate
		>Not forged*/
	public String extractUsername(String token)
	{
		return extractAllClaims(token).getSubject();
	}
	
	public Claims extractAllClaims(String token)
	{
		return Jwts.parserBuilder()
				.setSigningKey(getSignInKey())
				.build()
				.parseClaimsJws(token)
				.getBody();
	}
	
	// Validates: >Is token not expired? 
	// >Does token belong to this user?
	public boolean isTokenValid(String token, UserDetails  userDetails )
	{
		final String username = extractUsername(token);
		return (username.equals(userDetails.getUsername())) &&
				!isTokenExpired(token);
	}

	private boolean isTokenExpired(String token) 
	{
		return extractAllClaims(token).getExpiration().before(new Date());
	}
}
/*
This class handles creating and validating JWT tokens.

public String generateToken(User user) {}
This creates a token like this:-

Header 
{
    "alg": "HS256"
}

Payload 
{
    "sub": "a@a.com",
    "role": "CUSTOMER",
    "iat": now,
    "exp": 24hrs later
}

Signature 
{
    HMACSHA256(secret)
}
*/
// ---- End of JwtService.java ----


// ---- Start of AuthService.java ----
package com.shopease.backend.service;

import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import com.shopease.backend.dto.AuthenticationRequest;
import com.shopease.backend.dto.AuthenticationResponse;
import com.shopease.backend.dto.RegisterRequest;
import com.shopease.backend.entity.User;
import com.shopease.backend.repository.UserRepository;
import com.shopease.backend.security.JwtService;

@Service
public class AuthService 
{
	private UserRepository userRepository;
    private PasswordEncoder passwordEncoder;
    private JwtService jwtService;
    
	public AuthService(UserRepository userRepository, PasswordEncoder passwordEncoder, JwtService jwtService) 
	{
		this.userRepository = userRepository;
		this.passwordEncoder = passwordEncoder;
		this.jwtService = jwtService;
	}
    
    // Registration
	public AuthenticationResponse register(RegisterRequest request)
	{
		User user = new User();
		user.setName(request.getName());
		user.setEmail(request.getEmail());
		user.setPassword(passwordEncoder.encode(request.getPassword()));  // hash password
		user.setRole(request.getRole());
		
		userRepository.save(user);
		
		String token = jwtService.generateToken(user);
		
		return new AuthenticationResponse(token, "User registered Successfully");
	}
	
	// Login
	public AuthenticationResponse login(AuthenticationRequest request)
	{
		User user = userRepository.findByEmail(request.getEmail());
		
		if (user == null)
			return new AuthenticationResponse(null, "Invalid email");
		
		if (!passwordEncoder.matches(request.getPassword(), user.getPassword()))
			return new AuthenticationResponse(null, "Invalid password");
		
		String token = jwtService.generateToken(user);
		
		return new AuthenticationResponse(token, "Login successfull");
			
	}
}

// ---- End of AuthService.java ----


// ---- Start of CartService.java ----
package com.shopease.backend.service;

import java.util.ArrayList;

import org.springframework.stereotype.Service;

import com.shopease.backend.entity.Cart;
import com.shopease.backend.entity.CartItem;
import com.shopease.backend.entity.Product;
import com.shopease.backend.entity.User;
import com.shopease.backend.repository.CartItemRepository;
import com.shopease.backend.repository.CartRepository;
import com.shopease.backend.repository.ProductRepository;
import com.shopease.backend.repository.UserRepository;

@Service
public class CartService 
{
	private final CartRepository cartRepository;
    private final CartItemRepository cartItemRepository;
    private final ProductRepository productRepository;
    private final UserRepository userRepository;
    
	public CartService(
			CartRepository cartRepository,
			CartItemRepository cartItemRepository,
			ProductRepository productRepository,
			UserRepository userRepository
			)
	{
		this.cartRepository = cartRepository;
		this.cartItemRepository = cartItemRepository;
		this.productRepository = productRepository;
		this.userRepository = userRepository;
	}
	
    // Utility method → calc total
	private double calculateTotal(Cart cart)
	{
		return cart.getCartItems()
				.stream()
				.mapToDouble(CartItem::getPrice)
				.sum();
	}
	
	// 1 → Get cart of a user
	public Cart getCartByUser(Long userId)
	{
		User user = userRepository.findById(userId).orElse(null);
		
		if(user == null)
		{	return null;}
		
		Cart cart = cartRepository.findByUser(user);
		// If cart does not exist → create empty cart
		if (cart == null)
		{
			cart = new Cart();
			cart.setUser(user);
			cart.setCartItems(new ArrayList<>());
			cart.setTotalPrice(0);
			cart = cartRepository.save(cart);
		}
		return cart;		
	}
	
	// 2 → Add product to cart
	public Cart addProductToCart(Long userId,Long productId,int quantity)
	{
		Cart cart = getCartByUser(userId); //ensures cart exists
		Product product = productRepository.findById(productId).orElse(null);
		
		if(product==null)
			return null;
		
        // Create CartItem
		CartItem item = new CartItem();
		item.setCart(cart);
		item.setProduct(product);
		item.setQuantity(quantity);
		item.setPrice(product.getPrice()*quantity);
		
		cart.getCartItems().add(item);
		cartItemRepository.save(item);
		
		// Update total price
        cart.setTotalPrice(calculateTotal(cart));
        
        return cartRepository.save(cart);		
	}
	
    // 3 → Remove item from cart
	public Cart removeItemFromCart(Long userId, Long cartItemId)
	{
		Cart cart = getCartByUser(userId);
		
		CartItem item = cartItemRepository.findById(cartItemId).orElse(null);
		
		if(item==null)
			return cart;
		
		cart.getCartItems().remove(item);
		cartItemRepository.delete(item);
		
		cart.setTotalPrice(calculateTotal(cart));
		return cartRepository.save(cart);
	}
	
	
}























// ---- End of CartService.java ----


// ---- Start of CategoryService.java ----
package com.shopease.backend.service;


import java.util.List;

import org.springframework.stereotype.Service;

import com.shopease.backend.entity.Category;
import com.shopease.backend.repository.CategoryRepository;


@Service
public class CategoryService 
{
	private final CategoryRepository categoryRepository;
	
	public CategoryService(CategoryRepository categoryRepository)
	{
		this.categoryRepository = categoryRepository;
	}
	
	public Category createCategory(Category category)
	{
		return categoryRepository.save(category);
	}
	
	public List<Category> getAllCategories()
	{
		return categoryRepository.findAll();
	}
}

// ---- End of CategoryService.java ----


// ---- Start of OrderService.java ----
package com.shopease.backend.service;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

import org.springframework.stereotype.Service;

import com.shopease.backend.entity.Cart;
import com.shopease.backend.entity.CartItem;
import com.shopease.backend.entity.Order;
import com.shopease.backend.entity.OrderItem;
import com.shopease.backend.entity.OrderStatus;
import com.shopease.backend.entity.User;
import com.shopease.backend.repository.OrderItemRepository;
import com.shopease.backend.repository.OrderRepository;
import com.shopease.backend.repository.UserRepository;

@Service
public class OrderService 
{
    private OrderRepository orderRepository;
    private CartService cartService;
    private UserRepository userRepository;
    
	public OrderService(OrderRepository orderRepository,
			OrderItemRepository orderItemRepository,
			CartService cartService, 
			UserRepository userRepository) 
	{
		this.orderRepository = orderRepository;
		this.cartService = cartService;
		this.userRepository = userRepository;
	}
    
	public Order placeOrder(Long userId) 
	{
		// Get user
		User user = userRepository.findById(userId).orElse(null);
		
		if(user==null)
			return null;
		
		Cart cart = cartService.getCartByUser(userId);
		
		if(cart.getCartItems().isEmpty())
		{
			return null;  // empty cart
		}
		
		 // Create order
		Order order = new Order();
		order.setUser(user);
		order.setCreatedAt(LocalDateTime.now());
		order.setStatus(OrderStatus.PENDING);
		
		List<OrderItem> orderItems = new ArrayList<>();
		double total = 0;
		
		for (CartItem cartItem: cart.getCartItems())
		{
			OrderItem oi = new OrderItem();
			oi.setOrder(order);
			oi.setProduct(cartItem.getProduct());
			oi.setQuantity(cartItem.getQuantity());
			oi.setPrice(cartItem.getPrice());
			
			total += cartItem.getPrice();
            orderItems.add(oi);
		}
		
		order.setItems(orderItems);
		order.setTotalAmount(total);
		
		// Save order and items
		Order saveOrder = orderRepository.save(order);
		
		// clear cart
		cart.getCartItems().clear();
		cart.setTotalPrice(0);
		 
		return saveOrder;
	}
	
	public List<Order> getOrdersByUser(Long userId) 
	{
	    return orderRepository.findByUserId(userId);
	}
	
	public Order getOrderById(Long orderId)
	{
		return orderRepository.findById(orderId).orElse(null);
	}
	
	public Order cancelOrder(Long orderId)
	{
		Order order = orderRepository.findById(orderId).orElse(null);
		
		if(order == null)
			return null;
		
		if(order.getStatus() != OrderStatus.PENDING)
			return null;
		
		order.setStatus(OrderStatus.CANCELLED);
		
		return orderRepository.save(order);
	}
	
}




// ---- End of OrderService.java ----


// ---- Start of ProductService.java ----
package com.shopease.backend.service;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.shopease.backend.entity.Category;
import com.shopease.backend.entity.Product;
import com.shopease.backend.repository.CategoryRepository;
import com.shopease.backend.repository.ProductRepository;

@Service
public class ProductService 
{
	@Autowired
	ProductRepository productRepository;
	@Autowired
	private CategoryRepository categoryRepository;
	
	//addProduct
	public Product addProduct(Product product)
	{
		Long categoryId = product.getCategory().getId();
		
		Category category = categoryRepository.findById(categoryId)
				.orElseThrow(()->new RuntimeException("Category not found with ID: "+ categoryId));
		
		product.setCategory(category);
		
		return productRepository.save(product);
	}
	
	//getAllProducts
	public List<Product> getAllProducts()
	{
		return productRepository.findAll();
	}
	
	//getProductById
	public Product getProductById(Long id)
	{
		return productRepository.findById(id).orElse(null);
	}
	
	// Update product (including category)
    public Product updateProduct(Long id, Product updatedProduct) 
    {
        Product existing = productRepository.findById(id).orElse(null);

        if (existing == null)
        {
            return null;
        }

        existing.setName(updatedProduct.getName());
        existing.setDescription(updatedProduct.getDescription());
        existing.setPrice(updatedProduct.getPrice());

        // Update category
        if (updatedProduct.getCategory() != null)
        {
            Long categoryId = updatedProduct.getCategory().getId();
            Category category = categoryRepository.findById(categoryId)
                    .orElseThrow(() -> new RuntimeException("Category not found with ID: " + categoryId));
            existing.setCategory(category);
        }

        return productRepository.save(existing);
    }

	
	//deleteProduct
	public void deleteProduct(Long id)
	{
		productRepository.deleteById(id);
	}
}

// ---- End of ProductService.java ----


// ---- Start of UserService.java ----
package com.shopease.backend.service;

import com.shopease.backend.entity.User;

public interface UserService 
{
	User registerUser(User user);
	
	User findByEmail(String email);
}

// ---- End of UserService.java ----


// ---- Start of UserServiceImpl.java ----
package com.shopease.backend.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import com.shopease.backend.entity.User;
import com.shopease.backend.repository.UserRepository;

@Service
public class UserServiceImpl implements UserService
{
	@Autowired
	private UserRepository userRepository;

	@Override
	public User registerUser(User user) 
	{ 
		// simple registration (we will add password encryption later)
		return userRepository.save(user);
	}

	@Override
	public User findByEmail(String email) 
	{
		return userRepository.findByEmail(email);
	}

}

/*
 * What is a Service?
 * A Service is where your business logic lives.
 * 
 * Examples of business logic:
 * when a user registers → encrypt the password
 * check if email already exists
 * login → verify password
 * fetch user details
 * update profile
 * Service = logic layer.
 */
// ---- End of UserServiceImpl.java ----

